// =============================================================================
// SubTrack SaaS - Prisma Schema
// Multi-tenant subscription tracking with white-label support
// =============================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================================================
// Core Tenant Models
// =============================================================================

model Tenant {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique
  description String?
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  // Branding
  branding TenantBranding?

  // Relations
  users         User[]
  departments   Department[]
  subscriptions Subscription[]
  alertSettings AlertSettings?
  alertChannels AlertChannel[]
  alertsLog     AlertLog[]
  auditLogs     AuditLog[]

  @@map("tenants")
}

model TenantBranding {
  id          String  @id @default(uuid())
  tenantId    String  @unique @map("tenant_id")
  appName     String? @map("app_name")
  primaryColor String? @map("primary_color") // Hex color
  logoUrl     String? @map("logo_url")
  faviconUrl  String? @map("favicon_url")
  customCss   String? @map("custom_css")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("tenant_branding")
}

// =============================================================================
// User & Authentication Models
// =============================================================================

enum UserRole {
  SUPER_ADMIN
  TENANT_ADMIN
  FINANCE
  MANAGER
  VIEWER
}

enum UserStatus {
  ACTIVE
  INACTIVE
  SUSPENDED
  PENDING
}

model User {
  id            String     @id @default(uuid())
  tenantId      String?    @map("tenant_id")
  email         String
  passwordHash  String     @map("password_hash")
  firstName     String     @map("first_name")
  lastName      String     @map("last_name")
  role          UserRole   @default(VIEWER)
  status        UserStatus @default(ACTIVE)
  lastLoginAt   DateTime?  @map("last_login_at")
  lastLoginIp   String?    @map("last_login_ip")
  emailVerified Boolean    @default(false) @map("email_verified")
  createdAt     DateTime   @default(now()) @map("created_at")
  updatedAt     DateTime   @updatedAt @map("updated_at")

  // Relations
  tenant        Tenant?       @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  refreshTokens RefreshToken[]
  ownedSubscriptions Subscription[] @relation("SubscriptionOwner")
  auditLogs     AuditLog[]

  @@unique([tenantId, email])
  @@index([tenantId])
  @@index([email])
  @@map("users")
}

model RefreshToken {
  id        String    @id @default(uuid())
  userId    String    @map("user_id")
  token     String    @unique
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  createdAt DateTime  @default(now()) @map("created_at")
  ipAddress String?   @map("ip_address")
  userAgent String?   @map("user_agent")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@map("refresh_tokens")
}

// =============================================================================
// Department Model
// =============================================================================

model Department {
  id          String  @id @default(uuid())
  tenantId    String  @map("tenant_id")
  name        String
  description String?
  costCenter  String? @map("cost_center")
  managerId   String? @map("manager_id")
  isActive    Boolean @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  tenant        Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscriptions Subscription[]

  @@unique([tenantId, name])
  @@index([tenantId])
  @@map("departments")
}

// =============================================================================
// Subscription Models
// =============================================================================

enum BillingCycle {
  WEEKLY
  MONTHLY
  QUARTERLY
  ANNUAL
  CUSTOM
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAUSED
  TRIAL
  EXPIRED
}

model Subscription {
  id                String             @id @default(uuid())
  tenantId          String             @map("tenant_id")
  vendorName        String             @map("vendor_name")
  serviceName       String             @map("service_name")
  planName          String?            @map("plan_name")
  description       String?
  
  // Financial
  amount            Decimal            @db.Decimal(15, 2)
  currency          String             @default("USD")
  billingCycle      BillingCycle       @map("billing_cycle")
  customDays        Int?               @map("custom_days") // For CUSTOM billing cycle
  
  // Dates
  startDate         DateTime           @map("start_date")
  nextRenewalDate   DateTime           @map("next_renewal_date")
  endDate           DateTime?          @map("end_date")
  canceledAt        DateTime?          @map("canceled_at")
  
  // Status
  status            SubscriptionStatus @default(ACTIVE)
  autoRenew         Boolean            @default(true) @map("auto_renew")
  
  // Ownership
  departmentId      String?            @map("department_id")
  ownerId           String?            @map("owner_id")
  costCenter        String?            @map("cost_center")
  
  // URLs
  contractUrl       String?            @map("contract_url")
  invoiceUrl        String?            @map("invoice_url")
  vendorWebsite     String?            @map("vendor_website")
  adminPortalUrl    String?            @map("admin_portal_url")
  
  // Additional
  tags              String[]
  notes             String?
  
  createdAt         DateTime           @default(now()) @map("created_at")
  updatedAt         DateTime           @updatedAt @map("updated_at")
  createdBy         String?            @map("created_by")
  updatedBy         String?            @map("updated_by")

  // Relations
  tenant       Tenant                    @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  department   Department?               @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  owner        User?                     @relation("SubscriptionOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  attachments  SubscriptionAttachment[]
  alertLogs    AlertLog[]

  @@index([tenantId])
  @@index([tenantId, status])
  @@index([tenantId, nextRenewalDate])
  @@index([departmentId])
  @@index([ownerId])
  @@map("subscriptions")
}

model SubscriptionAttachment {
  id             String   @id @default(uuid())
  subscriptionId String   @map("subscription_id")
  fileName       String   @map("file_name")
  originalName   String   @map("original_name")
  mimeType       String   @map("mime_type")
  fileSize       Int      @map("file_size")
  filePath       String   @map("file_path")
  description    String?
  uploadedBy     String?  @map("uploaded_by")
  createdAt      DateTime @default(now()) @map("created_at")

  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@map("subscription_attachments")
}

// =============================================================================
// Alert & Notification Models
// =============================================================================

enum AlertRuleType {
  DAYS_14
  DAYS_7
  DAYS_3
  TOMORROW
  OVERDUE
  MONTHLY_SUMMARY
  DATA_QUALITY
}

enum AlertChannelType {
  GOOGLE_CHAT
  SLACK
  WEBHOOK
  EMAIL
}

model AlertSettings {
  id                 String   @id @default(uuid())
  tenantId           String   @unique @map("tenant_id")
  
  // Rule toggles
  enable14Days       Boolean  @default(true) @map("enable_14_days")
  enable7Days        Boolean  @default(true) @map("enable_7_days")
  enable3Days        Boolean  @default(true) @map("enable_3_days")
  enableTomorrow     Boolean  @default(true) @map("enable_tomorrow")
  enableOverdue      Boolean  @default(true) @map("enable_overdue")
  enableMonthlySummary Boolean @default(true) @map("enable_monthly_summary")
  enableDataQuality  Boolean  @default(true) @map("enable_data_quality")
  
  // Quiet hours (24h format)
  quietHoursStart    String?  @map("quiet_hours_start") // e.g., "22:00"
  quietHoursEnd      String?  @map("quiet_hours_end")   // e.g., "08:00"
  
  // Timezone
  timezone           String   @default("UTC")
  
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@map("alert_settings")
}

model AlertChannel {
  id          String          @id @default(uuid())
  tenantId    String          @map("tenant_id")
  name        String
  type        AlertChannelType
  webhookUrl  String          @map("webhook_url")
  isActive    Boolean         @default(true) @map("is_active")
  config      Json?           // Additional config per channel type
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")

  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
  @@map("alert_channels")
}

model AlertLog {
  id             String        @id @default(uuid())
  tenantId       String        @map("tenant_id")
  subscriptionId String?       @map("subscription_id")
  ruleType       AlertRuleType @map("rule_type")
  dueDate        DateTime      @map("due_date") // The renewal date this alert is for
  channelId      String        @map("channel_id")
  status         AlertStatus
  responseCode   Int?          @map("response_code")
  responseBody   String?       @map("response_body")
  errorMessage   String?       @map("error_message")
  retryCount     Int           @default(0) @map("retry_count")
  sentAt         DateTime?     @map("sent_at")
  createdAt      DateTime      @default(now()) @map("created_at")

  tenant       Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)

  @@index([tenantId, subscriptionId, ruleType, dueDate])
  @@index([tenantId, createdAt])
  @@map("alerts_log")
}

enum AlertStatus {
  PENDING
  SENT
  FAILED
  RETRYING
  CANCELED
}

// =============================================================================
// Audit Logging
// =============================================================================

enum AuditAction {
  CREATE
  UPDATE
  DELETE
  LOGIN
  LOGOUT
  EXPORT
  IMPORT
  SETTINGS_CHANGE
  PASSWORD_CHANGE
  USER_INVITE
  USER_ACTIVATE
  USER_DEACTIVATE
}

model AuditLog {
  id         String     @id @default(uuid())
  tenantId   String?    @map("tenant_id")
  userId     String?    @map("user_id")
  action     AuditAction
  entityType String     @map("entity_type") // e.g., "subscription", "user"
  entityId   String?    @map("entity_id")
  oldValues  Json?      @map("old_values")
  newValues  Json?      @map("new_values")
  ipAddress  String?    @map("ip_address")
  userAgent  String?    @map("user_agent")
  metadata   Json?
  createdAt  DateTime   @default(now()) @map("created_at")

  tenant Tenant? @relation(fields: [tenantId], references: [id], onDelete: SetNull)
  user   User?   @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([tenantId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

// =============================================================================
// Job Queue Tracking (for BullMQ)
// =============================================================================

model JobQueueState {
  id        String   @id @default(uuid())
  jobType   String   @map("job_type")
  jobId     String   @map("job_id")
  status    String   // queued, active, completed, failed
  data      Json?
  result    Json?
  error     String?
  startedAt DateTime? @map("started_at")
  endedAt   DateTime? @map("ended_at")
  createdAt DateTime @default(now()) @map("created_at")

  @@index([jobType, status])
  @@index([createdAt])
  @@map("job_queue_state")
}
